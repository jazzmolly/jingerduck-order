<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è–‘è–‘ é´¨è‚‰å°é¤¨ - ä¹çè–‘æ¯é´¨ ç·šä¸Šé»é¤</title>
    <style>
        :root {
            --brand: #b22222;
            --muted: #666;
            --card-bg: #fff7f7;
            --success: #28a745;
            --danger: #dc3545;
            --gap: 12px;
            --border-radius: 8px;
        }

        * { box-sizing: border-box; }
        body {
            font-family: "Noto Sans TC", Arial, sans-serif;
            margin: 0;
            background: #fafafa;
            color: #222;
            padding: 15px;
            line-height: 1.5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--brand);
        }

        h1 {
            margin: 0;
            color: var(--brand);
            font-size: 1.6rem;
            font-weight: 700;
        }

        .subtitle {
            color: var(--muted);
            margin: 5px 0 0 0;
            font-size: 0.95rem;
        }

        /* èœå–®è¡¨æ ¼ - æ”¹ç”¨å‚³çµ±è¡¨æ ¼çµæ§‹ */
        .menu-section {
            margin-bottom: 25px;
        }

        .menu-title {
            font-size: 1.1rem;
            color: var(--brand);
            margin: 0 0 15px 0;
            font-weight: 600;
        }

        .menu-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            overflow: hidden;
            background: white;
            margin-bottom: 20px; /* å¢åŠ è¡¨æ ¼é–“è· */
        }
        
        /* é¡åˆ¥æ¨™é¡Œæ¨£å¼ */
        .category-row th {
            background-color: #f8f8f8;
            color: var(--brand);
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 10px;
            border-bottom: 2px solid var(--brand);
        }

        .menu-header {
            background: var(--brand);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .menu-header:nth-child(2) { text-align: right; }
        .menu-header:nth-child(3) { text-align: center; }

        .menu-row {
            border-bottom: 1px solid #f0f0f0;
        }

        .menu-row:last-child {
            border-bottom: none;
        }
       
        .item-cell {
            padding: 12px 8px;
            vertical-align: middle;
        }

        .item-name-cell {
            padding-left: 12px;
            font-size: 0.95rem;
        }

        .item-checkbox {
            margin-right: 8px;
            transform: scale(1.1);
            accent-color: var(--brand);
            vertical-align: middle;
        }

        .item-name-text {
            display: inline-block;
            vertical-align: middle;
            line-height: 1.4;
        }

        .item-price-cell {
            text-align: right;
            color: var(--muted);
            font-weight: 500;
        }

        .item-qty-cell {
            text-align: center;
            padding: 4px;
        }

        /* æ•¸é‡æ§åˆ¶å™¨ */
        .qty-container {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            min-width: 70px;
            background: white;
        }

        .qty-input {
            width: 35px;
            padding: 6px 2px;
            border: none;
            text-align: center;
            font-size: 14px;
            background: white;
            color: #333;
            -moz-appearance: textfield;
        }

        .qty-input::-webkit-outer-spin-button,
        .qty-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: #f8f9fa;
            color: #666;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .qty-btn:hover:not(:disabled) {
            background: #e9ecef;
            color: var(--brand);
        }

        .qty-btn:active:not(:disabled) {
            background: #dee2e6;
            transform: scale(0.95);
        }

        .qty-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #ccc;
            background: #f8f8f8;
        }

        .qty-container.disabled {
            background: #f8f8f8 !important;
            border-color: #e0e0e0 !important;
        }

        .qty-container.disabled .qty-input {
            background: #f8f8f8 !important;
            color: #999 !important;
        }

        .qty-container.disabled .qty-btn {
            background: #f0f0f0 !important;
            color: #ccc !important;
        }

        /* ç¸½è¨ˆå€åŸŸ */
        .total-section {
            background: var(--card-bg);
            padding: 18px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            border: 1px solid #e8e8e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .total-label {
            font-size: 0.95rem;
            color: var(--muted);
        }

        .total-amount {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--brand);
        }

        .clear-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .clear-btn:hover {
            background: #c82333;
        }

        /* å–é¤è³‡è¨Šè¡¨å–® */
        .order-section {
            margin: 25px 0;
        }

        .section-title {
            font-size: 1.1rem;
            color: var(--brand);
            margin: 0 0 15px 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-label {
            font-size: 0.9rem;
            color: #555;
            font-weight: 500;
        }

        .form-input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 2px rgba(178, 34, 34, 0.1);
        }

        .form-input.error {
            border-color: var(--danger);
        }

        .form-input.required::after {
            content: " *";
            color: var(--danger);
        }

        .datetime-container {
            display: flex;
            gap: 12px;
            align-items: end;
        }

        .time-note {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 4px;
        }

        /* ç¢ºèªæŒ‰éˆ• */
        .confirm-section {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: var(--border-radius);
            margin: 25px 0;
        }

        .confirm-btn {
            background: var(--brand);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(178, 34, 34, 0.2);
            white-space: nowrap;
        }

        .confirm-btn:hover:not(:disabled) {
            background: #a11e1e;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(178, 34, 34, 0.3);
        }

        .confirm-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .share-section {
            display: none;
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
            border-radius: var(--border-radius);
            color: white;
            margin: 20px 0;
        }

        .share-btn {
            background: white;
            color: var(--success);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin: 8px;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            white-space: nowrap;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .share-btn.danger {
            background: var(--danger);
            color: white;
        }

        .order-summary {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--success);
            margin: 15px 0;
            font-family: "Courier New", monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            color: #333;
            max-height: 300px;
            overflow-y: auto;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            .menu-table { font-size: 0.9rem; }
            .item-name-cell { padding-left: 8px; font-size: 0.9rem; }
            .item-cell { padding: 10px 6px; }
            .qty-container { min-width: 65px; }
            .qty-btn { width: 26px; height: 26px; font-size: 15px; }
            .qty-input { width: 32px; font-size: 14px; }
            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .datetime-container {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }

            .total-section {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            h1 { font-size: 1.4rem; }
        }

        @media (max-width: 480px) {
            .item-name-cell { font-size: 0.85rem; }
            .qty-container { min-width: 60px; }
            .qty-btn { width: 24px; height: 24px; font-size: 14px; }
            .qty-input { width: 28px; font-size: 13px; }
        }

        /* æµ®å‹•æç¤ºæ¡†æ¨£å¼ */
        .promotion-message-popup {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: var(--brand);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 600;
            font-size: 1rem;
            white-space: pre-wrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            pointer-events: none;
            max-width: 85%;
        }
        
        .promotion-message-popup.visible {
            opacity: 1;
            visibility: visible;
        }

        /* ç¦ç”¨æ—¥æœŸæ¨£å¼ */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
        input[type="date"]:disabled {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="promotionMessage" class="promotion-message-popup"></div>

    <div class="container">
        <header>
            <h1>è–‘è–‘ é´¨è‚‰å°é¤¨</h1>
            <p class="subtitle">ä¹çè–‘æ¯é´¨ ç·šä¸Šé»é¤ç³»çµ±</p>
        </header>

        <section class="menu-section">
            <h2 class="menu-title">ğŸ² è«‹é¸æ“‡æƒ³è¦çš„å“é …</h2>
            <h3 style="color: #666; font-size: 1rem; margin-top: -5px;">
                å°èœè²·5é€1ï¼ˆé€60å°èœï¼‰
            </h3>
            
            <table class="menu-table">
                <thead>
                    <tr>
                        <th class="menu-header">å“å</th>
                        <th class="menu-header">å–®åƒ¹</th>
                        <th class="menu-header">æ•¸é‡</th>
                    </tr>
                </thead>
                <tbody id="menuBody">
                    </tbody>
            </table>
        </section>

        <section class="total-section">
            <div class="total-info">
                <div class="total-label">ç›®å‰è¨‚è³¼é‡‘é¡</div>
                <div class="total-amount" id="totalAmount">NT$0</div>
            </div>
            <button class="clear-btn" id="clearOrder">ğŸ—‘ï¸ æ¸…é™¤é¸å–®</button>
        </section>

        <section class="order-section">
            <h2 class="section-title">ğŸ“… å–é¤ / è¯çµ¡è³‡è¨Š</h2>
            <form id="orderForm" class="form-grid">
                <div class="form-group">
                    <label class="form-label required" for="customerName">å–é¤å§“å</label>
                    <input type="text" id="customerName" class="form-input" placeholder="è«‹è¼¸å…¥å–é¤å§“å" required>
                </div>

                <div class="form-group">
                    <label class="form-label required" for="customerPhone">è¯çµ¡é›»è©±</label>
                    <input type="tel" id="customerPhone" class="form-input" placeholder="09xx-xxx-xxx" pattern="09[0-9]{2}-?[0-9]{3}-?[0-9]{3}" required>
                </div>

                <div class="form-group datetime-container">
                    <div style="flex: 1;">
                        <label class="form-label required" for="pickupDate">å–é¤æ—¥æœŸ</label>
                        <input type="date" id="pickupDate" class="form-input" required>
                    </div>
                    <div style="flex: 1;">
                        <label class="form-label required" for="pickupTime">å–é¤æ™‚é–“ <span class="time-note">(ç‡Ÿæ¥­æ™‚é–“ 11:00-19:00)</span></label>
                        <input type="time" id="pickupTime" class="form-input" min="11:00" max="19:00" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="orderNote">å‚™è¨»</label>
                    <textarea id="orderNote" class="form-input" rows="3" placeholder="ä¾‹å¦‚ï¼šæˆ‘è¦åŠ è¾£ã€ä¸è¦åŠ ç±³é…’ã€éºµç·šä¸è¦æ²¹è‘±é…¥ç­‰..."></textarea>
                </div>
            </form>
        </section>

        <section class="confirm-section">
            <button class="confirm-btn" id="confirmOrder" disabled>âœ… ç¢ºèªè¨‚å–®</button>
            <div id="shareSection" class="share-section">
                <h3 style="margin: 0 0 15px 0;">ğŸ‰ è¨‚å–®å·²æº–å‚™å®Œæˆï¼</h3>
                <p style="margin: 0 0 20px 0; opacity: 0.9;">è«‹åˆ†äº«è¨‚å–®çµ¦åº—å®¶ï¼Œæˆ‘å€‘æœƒç›¡å¿«ç‚ºæ‚¨æº–å‚™</p>
                <div id="orderPreview" class="order-summary"></div>
                <a href="#" id="shareToLine" class="share-btn">ğŸ“± åˆ†äº«çµ¦åº—å®¶LINE</a>
                <button id="copyOrder" class="share-btn">ğŸ“‹ è¤‡è£½è¨‚å–®</button>
                <button id="backToMenu" class="share-btn danger">ğŸ”„ è¿”å›é¸å–®</button><br>
                å°‡è¨‚å–®åˆ†äº«çµ¦åº—å®¶çš„å®˜æ–¹å¸³è™Ÿï¼ˆ@198usxgcï¼‰ï¼Œæ‰ç®—å®Œæˆè¨‚å–®å“¦ï¼
            </div>
        </section>

        <footer style="text-align: center; margin-top: 30px; color: var(--muted); font-size: 0.85rem; padding-top: 20px; border-top: 1px solid #eee;">
            <p>è–‘è–‘ é´¨è‚‰å°é¤¨ | ä¹çè–‘æ¯é´¨å°ˆè³£ | æ­¡è¿å…‰è‡¨ï¼</p>
        </footer>
    </div>

    <script>
        // ===== èœå–®è³‡æ–™ - æ–°å¢é¡åˆ¥ =====
        const menuData = [
            {
                category: "è–‘æ¯é´¨é¡",
                items: [
                    { id: "duck-large", name: "è–‘æ¯é´¨ï¼ˆå¤§, 12å¡Šè‚‰,4000gï¼‰/4åŒ…è±†è…ä¹³", price: 450 },
                    { id: "duck-medium", name: "è–‘æ¯é´¨ï¼ˆä¸­, 9å¡Šè‚‰,3000gï¼‰/3åŒ…è±†è…ä¹³", price: 350 },
                    { id: "duck-small", name: "è–‘æ¯é´¨ï¼ˆå°, 6å¡Šè‚‰,2000gï¼‰/2åŒ…è±†è…ä¹³", price: 250 },
                    { id: "soup-base", name: "æ¹¯åº•(æ²’æœ‰è‚‰,æ¶ˆè²»æ»¿250åŠ è³¼åƒ¹)(1500g)", price: 100 }
                ]
            },
            {
                category: "å°èœé¡",
                items: [
                    { id: "duck-ball", name: "é´¨è‚‰ä¸¸", price: 60 },
                    { id: "squid-ball", name: "èŠ±æä¸¸ï¼ˆåƒå¾—åˆ°èŠ±æå“¦ï¼‰", price: 60 },
                    { id: "frozen-tofu", name: "å‡è±†è…", price: 60 },
                    { id: "tofu-sheet", name: "ç™¾é è±†è…", price: 60 },
                    { id: "enoki-mushroom", name: "é‡‘é‡è‡", price: 60 },
                    { id: "abalone-mushroom", name: "æåŒ…è‡", price: 60 },
                    { id: "Bok-choy", name: "é’æ±Ÿèœ", price: 60 },
                    { id: "cabbage", name: "é«˜éº—èœ", price: 60 },                    
                    { id: "down-o", name: "èŒ¼èµ", price: 60 },
                    { id: "rice-cake", name: "ç±³è¡€ç³•", price: 60 },
                    { id: "sausage", name: "é‘«é‘«è…¸", price: 60 },
                    { id: "bean-curd", name: "è±†çš®", price: 60 },
                    { id: "grilled-mochi", name: "éº»å‰ç‡’", price: 60 },
                    { id: "noodles", name: "éº»æ²¹éºµç·š"(ç¾å ´è£½ä½œï¼‰, price: 50 },                    
                ]
            },
             {
                category: "è‚‰ç‰‡é¡",
                items: [
                    { id: "beef-slices", name: "åŸ¹æ ¹ç‰›", price: 100 },
                    { id: "pork-slices", name: "æ¢…èŠ±è±¬", price: 90 },
                    
                ]
            },        
            {
                category: "å…¶å®ƒ",
                items: [
                    { id: "jinger-juice", name: "è–‘æ±", price: 50 },                    
                    { id: "prince-noodles", name: "ç‹å­éºµ", price: 15 },
                    { id: "tofu-pickle", name: "è±†è…ä¹³", price: 10 }
                ]
            },
        ];
        
        // ===== è¼”åŠ©å‡½å¼ï¼šæ ¹æ“š ID å°‹æ‰¾èœå–®é …ç›® =====
        function findItemById(itemId) {
            for (const category of menuData) {
                const item = category.items.find(i => i.id === itemId);
                if (item) {
                    return { ...item, category: category.category };
                }
            }
            return null;
        }
        
        let currentOrderId = null;
        let promotionTimeoutId = null;

        // ===== åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            initMenu();
            initDateTime();
            initEventListeners();
            updateOrderData(); // åˆå§‹è¼‰å…¥æ™‚è¨ˆç®—ç¸½åƒ¹
        });
        
        // ===== åˆå§‹åŒ–èœå–® (æ›´æ–°ç‰ˆï¼Œèƒ½è™•ç†é¡åˆ¥) =====
        function initMenu() {
            const menuBody = document.getElementById('menuBody');
            menuBody.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹

            menuData.forEach(category => {
                // å»ºç«‹é¡åˆ¥æ¨™é¡Œè¡Œ
                const categoryRow = document.createElement('tr');
                categoryRow.className = 'category-row';
                categoryRow.innerHTML = `<th colspan="3">${category.category}</th>`;
                menuBody.appendChild(categoryRow);

                // å»ºç«‹è©²é¡åˆ¥ä¸‹çš„æ‰€æœ‰èœå“
                category.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'menu-row';

                    // å“åå–®å…ƒæ ¼
                    const nameCell = document.createElement('td');
                    nameCell.className = 'item-cell item-name-cell';
                    nameCell.innerHTML = `
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; width: 100%;">
                            <input type="checkbox" class="item-checkbox" id="${item.id}" data-price="${item.price}" data-name="${item.name}">
                            <span class="item-name-text">${item.name}</span>
                        </label>
                    `;

                    // åƒ¹æ ¼å–®å…ƒæ ¼
                    const priceCell = document.createElement('td');
                    priceCell.className = 'item-cell item-price-cell';
                    priceCell.textContent = `NT$${item.price}`;

                    // æ•¸é‡å–®å…ƒæ ¼
                    const qtyCell = document.createElement('td');
                    qtyCell.className = 'item-cell item-qty-cell';
                    qtyCell.innerHTML = `
                        <div class="qty-container disabled" data-qty-id="${item.id}">
                            <button type="button" class="qty-btn" id="minus-${item.id}" disabled>-</button>
                            <input type="number" class="qty-input" id="qty-${item.id}" value="0" readonly>
                            <button type="button" class="qty-btn" id="plus-${item.id}" disabled>+</button>
                        </div>
                    `;
                    row.appendChild(nameCell);
                    row.appendChild(priceCell);
                    row.appendChild(qtyCell);
                    menuBody.appendChild(row);

                    // ç¶å®šäº‹ä»¶
                    bindItemEvents(item.id);
                });
            });
        }

        // ===== ç¶å®šèœå–®é …ç›®äº‹ä»¶ =====
        function bindItemEvents(itemId) {
            const checkbox = document.getElementById(itemId);
            const qtyContainer = document.querySelector(`[data-qty-id="${itemId}"]`);
            const minusBtn = document.getElementById(`minus-${itemId}`);
            const plusBtn = document.getElementById(`plus-${itemId}`);
            const qtyInput = document.getElementById(`qty-${itemId}`);
            
            // Checkbox è®Šæ›´äº‹ä»¶
            checkbox.addEventListener('change', function() {
                const isChecked = this.checked;
                const currentQty = parseInt(qtyInput.value) || 0;
                
                if (isChecked) {
                    qtyContainer.classList.remove('disabled');
                    minusBtn.disabled = false;
                    plusBtn.disabled = false;
                    qtyInput.readOnly = false;
                    if (currentQty === 0) {
                        qtyInput.value = 1;
                    }
                } else {
                    qtyContainer.classList.add('disabled');
                    minusBtn.disabled = true;
                    plusBtn.disabled = true;
                    qtyInput.readOnly = true;
                    qtyInput.value = 0;
                }
                
                updateOrderData();
            });

            // åŠ æ¸›æŒ‰éˆ•äº‹ä»¶
            minusBtn.addEventListener('click', function() {
                if (!this.disabled) {
                    let current = parseInt(qtyInput.value) || 0;
                    if (current > 1) {
                        qtyInput.value = current - 1;
                        updateOrderData();
                    } else if (current === 1) {
                        qtyInput.value = 0;
                        checkbox.checked = false;
                        qtyContainer.classList.add('disabled');
                        minusBtn.disabled = true;
                        plusBtn.disabled = true;
                        qtyInput.readOnly = true;
                        updateOrderData();
                    }
                }
            });

            plusBtn.addEventListener('click', function() {
                if (!this.disabled) {
                    let current = parseInt(qtyInput.value) || 0;
                    qtyInput.value = current + 1;
                    checkbox.checked = true;
                    updateOrderData();
                }
            });

            // æ‰‹å‹•è¼¸å…¥é©—è­‰
            qtyInput.addEventListener('input', function(e) {
                let value = parseInt(e.target.value);
                if (isNaN(value) || value < 0) {
                    e.target.value = 0;
                    checkbox.checked = false;
                    qtyContainer.classList.add('disabled');
                    minusBtn.disabled = true;
                    plusBtn.disabled = true;
                    this.readOnly = true;
                } else {
                    checkbox.checked = value > 0;
                    if (value > 0) {
                        qtyContainer.classList.remove('disabled');
                        minusBtn.disabled = false;
                        plusBtn.disabled = false;
                        this.readOnly = false;
                    }
                }
                updateOrderData();
            });
        }

        // ===== æ›´æ–°è¨‚å–®è³‡æ–™çš„å‡½å¼ =====
        let totalResult = {
            items: [],
            total: 0,
            customer: {}
        };
        
        function updateOrderData() {
            const selectedItems = [];
            
            menuData.forEach(category => {
                category.items.forEach(item => {
                    const checkbox = document.getElementById(item.id);
                    const qtyInput = document.getElementById(`qty-${item.id}`);

                    if (checkbox && checkbox.checked) {
                        const qty = parseInt(qtyInput.value) || 0;
                        if (qty > 0) {
                            selectedItems.push({
                                id: item.id,
                                name: item.name,
                                price: item.price,
                                qty: qty,
                                category: category.category
                            });
                        }
                    }
                });
            });
            
            totalResult.items = selectedItems;
            
            calculateTotal();
            displayPromotionMessage();
            updateConfirmButton();
        }
        
        // ===== è¨ˆç®—ç¸½é‡‘é¡ (ä¿®æ­£ç‰ˆï¼ŒåŒ…å«å…©ç¨®å„ªæƒ ) =====
        function calculateTotal() {
            let finalTotal = 0;
            let sideDishCount = 0;
            let meatCount = 0;

            // 1. å…ˆè¨ˆç®—åŸå§‹ç¸½åƒ¹å’Œå„å“é …æ•¸é‡
            totalResult.items.forEach(item => {
                finalTotal += item.price * item.qty;
                if (item.category === 'å°èœé¡') {
                    sideDishCount += item.qty;
                }
                if (item.category === 'å–®é»è‚‰é¡') {
                    meatCount += item.qty;
                }
            });
            
            // 2. è¨ˆç®—ä¸¦å¥—ç”¨ã€Œå°èœã€æŠ˜æ‰£
            const freeSideDishes = Math.floor(sideDishCount / 6);
            const sideDishDiscount = freeSideDishes * 60;
            
            if (sideDishDiscount > 0) {
                finalTotal -= sideDishDiscount;
            }

            // 3. è¨ˆç®—ä¸¦å¥—ç”¨ã€Œè‚‰å“ã€æŠ˜æ‰£
            const freeMeats = Math.floor(meatCount / 6);
            const meatDiscount = freeMeats * 90;
            
            if (meatDiscount > 0) {
                finalTotal -= meatDiscount;
            }
            
            totalResult.total = finalTotal;
            updateOrderDisplay();
        }

        // ===== é¡¯ç¤ºå³æ™‚å„ªæƒ æé†’è¨Šæ¯ (ä¿®æ­£ç‰ˆ) =====
        function displayPromotionMessage() {
            const messageElement = document.getElementById('promotionMessage');
            let sideDishCount = 0;
            let meatCount = 0;
            let messages = [];

            totalResult.items.forEach(item => {
                if (item.category === 'å°èœé¡') {
                    sideDishCount += item.qty;
                }
                if (item.category === 'å–®é»è‚‰é¡') {
                    meatCount += item.qty;
                }
            });

            // å°èœæé†’
            if (sideDishCount > 0) {
                if (sideDishCount % 6 === 5) {
                    messages.push("æ‚¨å·±é”åˆ°å°èœè²·5é€1å„ªæƒ ï¼Œè«‹å†å…è²»é¸1ä»½å°èœï¼");
                } else if (sideDishCount % 6 === 0) {
                    messages.push("ğŸ‘ å°èœå·²é”æˆè²·5é€1å„ªæƒ ï¼");
                }
            }

            // è‚‰å“æé†’
            if (meatCount > 0) {
                if (meatCount % 6 === 5) {
                    messages.push("æ‚¨å·±é”åˆ°è‚‰å“è²·5é€1å„ªæƒ ï¼Œè«‹å†å…è²»é¸1ä»½90å…ƒè‚‰å“ï¼");
                } else if (meatCount % 6 === 0) {
                    messages.push("ğŸ‘ è‚‰å“å·²é”æˆè²·5é€1å„ªæƒ ï¼");
                }
            }

            // é¡¯ç¤ºæˆ–éš±è—æµ®å‹•è¦–çª—
            if (messages.length > 0) {
                messageElement.textContent = messages.join('\n'); // ä½¿ç”¨æ›è¡Œç¬¦è™Ÿ
                messageElement.classList.add('visible');
                // æ¸…é™¤èˆŠçš„è¨ˆæ™‚å™¨ï¼Œé¿å…é‡è¤‡
                if (promotionTimeoutId) {
                    clearTimeout(promotionTimeoutId);
                }
                // è¨­å®šæ–°çš„è¨ˆæ™‚å™¨ï¼Œ3ç§’å¾Œéš±è—
                promotionTimeoutId = setTimeout(() => {
                    messageElement.classList.remove('visible');
                }, 3000);
            } else {
                // å¦‚æœæ²’æœ‰è¨Šæ¯ï¼Œç¢ºä¿è¦–çª—éš±è—
                messageElement.classList.remove('visible');
                if (promotionTimeoutId) {
                    clearTimeout(promotionTimeoutId);
                }
            }
        }

        // ===== æ›´æ–°ç¶²é é¡¯ç¤º =====
        function updateOrderDisplay() {
            document.getElementById('totalAmount').textContent = `NT$${totalResult.total.toLocaleString()}`;
        }

        // ===== æ›´æ–°ç¢ºèªæŒ‰éˆ•ç‹€æ…‹ =====
        function updateConfirmButton() {
            const form = document.getElementById('orderForm');
            const isFormValid = form.checkValidity();
            const hasItems = totalResult.items.length > 0;
            const confirmBtn = document.getElementById('confirmOrder');
            confirmBtn.disabled = !(hasItems && isFormValid);
        }

        // ===== è¡¨å–®é©—è­‰ =====
        function validateInput(e) {
            const input = e.target;
            const isValid = input.checkValidity();

            if (input.type === 'tel') {
                const phonePattern = /^09[0-9]{2}-?[0-9]{3}-?[0-9]{3}$/;
                if (!phonePattern.test(input.value)) {
                    input.setCustomValidity('è«‹è¼¸å…¥æ­£ç¢ºçš„å°ç£æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ (09xx-xxx-xxx)');
                } else {
                    input.setCustomValidity('');
                }
            }

            if (isValid) {
                input.classList.remove('error');
            } else {
                input.classList.add('error');
            }
            updateConfirmButton();
        }

        // ===== äº‹ä»¶ç›£è½å™¨ =====
        function initEventListeners() {
            document.getElementById('clearOrder').addEventListener('click', clearOrder);
            document.getElementById('confirmOrder').addEventListener('click', confirmOrder);
            document.getElementById('shareToLine').addEventListener('click', shareToLine);
            document.getElementById('copyOrder').addEventListener('click', copyOrder);
            document.getElementById('backToMenu').addEventListener('click', backToMenu);

            const formInputs = document.querySelectorAll('.form-input[required]');
            formInputs.forEach(input => {
                input.addEventListener('blur', validateInput);
                input.addEventListener('input', validateInput);
            });
        }

        // ===== åˆå§‹åŒ–æ—¥æœŸæ™‚é–“ (ä¿®æ­£ç‰ˆ) =====
        function initDateTime() {
            const pickupDate = document.getElementById('pickupDate');
            const pickupTime = document.getElementById('pickupTime');
            
            // è™•ç†æ—¥æœŸï¼šé–å®šæ˜ŸæœŸä¸€
            const today = new Date();
            let tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);

            // å¦‚æœä»Šå¤©æˆ–æ˜å¤©æ˜¯æ˜ŸæœŸä¸€ï¼Œå‰‡è·³é
            if (today.getDay() === 1) { // 1ä»£è¡¨æ˜ŸæœŸä¸€
                tomorrow.setDate(today.getDate() + 2); // è·³åˆ°æ˜ŸæœŸäºŒ
            } else if (tomorrow.getDay() === 1) {
                tomorrow.setDate(tomorrow.getDate() + 1); // è·³åˆ°æ˜ŸæœŸäºŒ
            }

            // ç¢ºä¿åˆå§‹æ—¥æœŸä¸æ˜¯æ˜ŸæœŸä¸€
            let initialDate = new Date(today);
            while (initialDate.getDay() === 1) {
                initialDate.setDate(initialDate.getDate() + 1);
            }
            pickupDate.value = initialDate.toISOString().split('T')[0];
            pickupDate.min = initialDate.toISOString().split('T')[0];

            // ç›£è½æ—¥æœŸè®Šæ›´
            pickupDate.addEventListener('input', function() {
                const selectedDate = new Date(this.value);
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ˜ŸæœŸä¸€
                if (selectedDate.getDay() === 1) {
                    alert('ä¸å¥½æ„æ€ï¼Œæˆ‘å€‘å¸‚å ´å…¬ä¼‘ï¼Œæ¯é€±ä¸€ä¸ç‡Ÿæ¥­ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸï¼');
                    
                    // è‡ªå‹•è·³åˆ°éš”å¤© (æ˜ŸæœŸäºŒ)
                    const nextDay = new Date(selectedDate);
                    nextDay.setDate(selectedDate.getDate() + 1);
                    this.value = nextDay.toISOString().split('T')[0];
                }
            });

            // è™•ç†æ™‚é–“ï¼šè¨­å®šç‚º24å°æ™‚åˆ¶
            const now = new Date();
            const hours = now.getHours();
            let initialTime;
            if (hours < 11) {
                initialTime = "11:00";
            } else if (hours > 19) {
                initialTime = "19:00";
            } else {
                initialTime = `${hours.toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            }

            // è¨­å®šé è¨­å–é¤æ™‚é–“
            pickupTime.value = '11:00';
            
            // ç›£è½æ™‚é–“è®Šæ›´
            pickupTime.addEventListener('change', function() {
                const time = this.value;
                if (time < '11:00' || time > '19:00') {
                    alert('å–é¤æ™‚é–“è«‹é¸æ“‡ 11:00-19:00 ä¹‹é–“');
                    this.value = '11:00';
                }
            });
        }

        // ===== æ¸…é™¤è¨‚å–® =====
        function clearOrder() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤ç›®å‰é¸å–®å—ï¼Ÿ')) {
                menuData.forEach(category => {
                    category.items.forEach(item => {
                        const checkbox = document.getElementById(item.id);
                        const qtyInput = document.getElementById(`qty-${item.id}`);
                        const qtyContainer = document.querySelector(`[data-qty-id="${item.id}"]`);
                        const minusBtn = document.getElementById(`minus-${item.id}`);
                        const plusBtn = document.getElementById(`plus-${item.id}`);
                        
                        if (checkbox) checkbox.checked = false;
                        if (qtyInput) qtyInput.value = '0';
                        if (qtyContainer) qtyContainer.classList.add('disabled');
                        if (minusBtn) minusBtn.disabled = true;
                        if (plusBtn) plusBtn.disabled = true;
                        if (qtyInput) qtyInput.readOnly = true;
                    });
                });
                document.getElementById('orderForm').reset();
                initDateTime();
                updateOrderData();
                hideShareSection();
                alert('é¸å–®å·²æ¸…é™¤ï¼');
            }
        }

        // ===== ç¢ºèªè¨‚å–® =====
        async function confirmOrder() {
            const form = document.getElementById('orderForm');
            if (!form.checkValidity()) {
                alert('è«‹å¡«å¯«å®Œæ•´çš„å–é¤è³‡è¨Šï¼');
                form.reportValidity();
                return;
            }
            if (totalResult.items.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å“é …ï¼');
                return;
            }

            // ç”Ÿæˆè¨‚å–®ç·¨è™Ÿ
            const timestamp = new Date().getTime();
            currentOrderId = `JD${timestamp.toString().slice(-6)}`;

            // é¡¯ç¤ºè¨‚å–®é è¦½
            showOrderPreview();

            // é¡¯ç¤ºåˆ†äº«å€å¡Š
            showShareSection();
            
            // æ»¾å‹•åˆ°åˆ†äº«å€
            document.getElementById('shareSection').scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });

            // ç™¼é€åˆ° Google Sheetsï¼ˆéåŒæ­¥ï¼‰
            await saveToGoogleSheets(totalResult);
        }

        // ===== é¡¯ç¤ºè¨‚å–®é è¦½ =====
        function showOrderPreview() {
            const now = new Date();
            const orderTime = now.toLocaleString('zh-TW', {
                timeZone: 'Asia/Taipei',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const pickupDate = document.getElementById('pickupDate').value;
            const pickupTime = document.getElementById('pickupTime').value;
            const orderNote = document.getElementById('orderNote').value || 'ç„¡å‚™è¨»';
            const pickupDateTime = `${pickupDate.replace(/-/g, '/')} ${pickupTime}`;

            let itemsText = totalResult.items.map(item =>
                `â€¢ ${item.name} Ã— ${item.qty} â†’ NT$${(item.price * item.qty).toLocaleString()}`
            ).join('\n');
            
            // å¦‚æœæœ‰æŠ˜æ‰£ï¼Œå°‡å…¶åŠ å…¥æ˜ç´°ä¸­
            const totalBeforeDiscount = totalResult.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const totalDiscount = totalBeforeDiscount - totalResult.total;
            if (totalDiscount > 0) {
                itemsText += `\n\nå„ªæƒ æŠ˜æ‰£ï¼š-NT$${totalDiscount.toLocaleString()}`;
            }

            const previewText = `ğŸ”” è–‘è–‘é´¨è‚‰å°é¤¨ æ–°è¨‚å–® #${currentOrderId}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¨‚å–®æ™‚é–“ï¼š${orderTime}

ğŸ“‹ è¨‚å–®æ˜ç´°ï¼š
${itemsText}

ğŸ’° ç¸½é‡‘é¡ï¼šNT$${totalResult.total.toLocaleString()}

ğŸ‘¤ å–é¤è³‡è¨Šï¼š
å§“åï¼š${customerName}
é›»è©±ï¼š${customerPhone}
å–é¤æ™‚é–“ï¼š${pickupDateTime}
å‚™è¨»ï¼š${orderNote}

ğŸ“ åº—å®¶ï¼šè–‘è–‘ é´¨è‚‰å°é¤¨
è«‹æ–¼å–é¤æ™‚é–“å‰åˆ°åº—é ˜å–ï¼Œè¬è¬æƒ é¡§ï¼`;

            document.getElementById('orderPreview').textContent = previewText;
        }

        // ===== é¡¯ç¤ºåˆ†äº«å€å¡Š =====
        function showShareSection() {
            document.getElementById('confirmOrder').style.display = 'none';
            document.getElementById('shareSection').style.display = 'block';
        }

        // ===== éš±è—åˆ†äº«å€å¡Š =====
        function hideShareSection() {
            document.getElementById('confirmOrder').style.display = 'block';
            document.getElementById('shareSection').style.display = 'none';
        }

        // ===== åˆ†äº«åˆ° LINE =====
        function shareToLine() {
            const orderPreview = document.getElementById('orderPreview').textContent;
            const encodedText = encodeURIComponent(orderPreview);
            const lineUrl = `https://line.me/R/msg/text/?${encodedText}`;
            window.open(lineUrl, '_blank');
            alert('è¨‚å–®å·²é–‹å•Ÿ LINEï¼Œè«‹é¸æ“‡å‚³é€çµ¦åº—å®¶ (@198usxgc) æˆ–å…¶ä»–è¯çµ¡äººï¼');
        }

        // ===== è¤‡è£½è¨‚å–® =====
        async function copyOrder() {
            const orderPreview = document.getElementById('orderPreview').textContent;
            try {
                await navigator.clipboard.writeText(orderPreview);
                alert('è¨‚å–®å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼è«‹è²¼åˆ° LINE æˆ–å…¶ä»–é€šè¨Šè»Ÿé«”å‚³é€çµ¦åº—å®¶ã€‚');
            } catch (err) {
                const textArea = document.createElement('textarea');
                textArea.value = orderPreview;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('è¨‚å–®å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼è«‹è²¼åˆ° LINE æˆ–å…¶ä»–é€šè¨Šè»Ÿé«”å‚³é€çµ¦åº—å®¶ã€‚');
            }
        }

        // ===== è¿”å›é¸å–® =====
        function backToMenu() {
            hideShareSection();
            document.getElementById('confirmOrder').style.display = 'block';
        }

        // ===== å„²å­˜åˆ° Google Sheets =====
        async function saveToGoogleSheets(totalResult) {
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbwwC6HFuGUo_U_VxRfGgBX1zQbmXAkZUOTe7zul1VQVInZ2ry5-vKM8L4toVdu74F0eaQ/exec';

            if (scriptUrl === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
                console.log('Google Sheets æ•´åˆï¼šè«‹è¨­å®š Google Apps Script Web App URL');
                return;
            }

            try {
                const orderData = {
                    orderId: currentOrderId,
                    orderTime: new Date().toISOString(),
                    items: totalResult.items.map(item => ({
                        ...item,
                        subtotal: item.price * item.qty
                    })),
                    total: totalResult.total,
                    customer: {
                        name: document.getElementById('customerName').value,
                        phone: document.getElementById('customerPhone').value,
                        pickupDate: document.getElementById('pickupDate').value,
                        pickupTime: document.getElementById('pickupTime').value,
                        note: document.getElementById('orderNote').value || 'ç„¡å‚™è¨»'
                    }
                };

                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Google Apps Script éœ€è¦ no-cors
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });

                console.log('è¨‚å–®å·²å„²å­˜åˆ° Google Sheets');
            } catch (error) {
                console.error('å„²å­˜åˆ° Google Sheets å¤±æ•—ï¼š', error);
                // å³ä½¿å¤±æ•—ä¹Ÿä¸å½±éŸ¿ä¸»è¦æµç¨‹
            }
        }

        // ===== å³æ™‚æ›´æ–°ç¢ºèªæŒ‰éˆ• =====
        document.addEventListener('change', updateConfirmButton);
        document.addEventListener('input', updateConfirmButton);
    </script>
</body>
</html>
















