<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>薑薑 鴨肉小館 - 線上點餐</title>
    <style>
        /* 為了簡潔，這裡只包含基礎樣式，您可以替換為您原本的 CSS */
        :root {
            --brand: #b22222;
            --muted: #666;
            --card-bg: #fff7f7;
            --success: #28a745;
            --danger: #dc3545;
            --gap: 12px;
            --border-radius: 8px;
        }

        * { box-sizing: border-box; }
        body {
            font-family: "Noto Sans TC", Arial, sans-serif;
            margin: 0;
            background: #fafafa;
            color: #222;
            padding: 15px;
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        h2 { border-bottom: 2px solid var(--brand); padding-bottom: 8px; margin-top: 20px; }
        
        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .qty-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .qty-control.disabled button,
        .qty-control.disabled input {
            opacity: 0.5;
            pointer-events: none;
        }

        /* 表單樣式 */
        .form-group label { display: block; margin-top: 10px; font-weight: bold; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* 按鈕樣式 */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-brand { background: var(--brand); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        /* 訂單總覽 */
        #orderResult {
            margin-top: 20px;
            padding: 15px;
            background: var(--card-bg);
            border: 1px solid var(--brand);
            border-radius: var(--border-radius);
        }
        
        #shareSection {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f0f8ff;
            border: 2px solid #007bff;
            border-radius: var(--border-radius);
            text-align: center;
        }

        #orderPreview {
            white-space: pre-wrap;
            text-align: left;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            background: white;
            font-family: monospace;
        }

        .share-actions button { margin: 5px; }

    </style>
</head>
<body>
    <div class="container">
        <h1>薑薑 鴨肉小館 線上點餐</h1>

        <h2>🛒 選擇品項</h2>
        <div id="menu">
            </div>

        <div id="orderResult">
            <h3>💰 訂單總計</h3>
            <p>已選品項數：<span id="totalItemsQty">0</span> 份</p>
            <p>總金額：<span id="totalAmount">NT$0</span></p>
        </div>
        
        <h2>📝 取餐資訊</h2>
        <form id="orderForm" novalidate>
            <div class="form-group">
                <label for="customerName">姓名 *</label>
                <input type="text" id="customerName" name="customerName" required placeholder="請輸入姓名" data-validate-type="text">
            </div>
            <div class="form-group">
                <label for="customerPhone">電話 *</label>
                <input type="tel" id="customerPhone" name="customerPhone" required placeholder="請輸入電話號碼" data-validate-type="phone">
            </div>
            <div class="form-group">
                <label for="pickupDate">取餐日期 *</label>
                <input type="date" id="pickupDate" name="pickupDate" required>
            </div>
            <div class="form-group">
                <label for="pickupTime">取餐時間 * (11:00-19:00)</label>
                <input type="time" id="pickupTime" name="pickupTime" required min="11:00" max="19:00" step="300">
            </div>
            <div class="form-group">
                <label for="orderNote">訂單備註</label>
                <textarea id="orderNote" name="orderNote" rows="3" placeholder="特殊需求或備註"></textarea>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button type="button" id="clearOrderBtn" class="btn-danger" onclick="clearOrder()">🗑️ 清除選單</button>
                <button type="button" id="confirmOrder" class="btn-brand" onclick="confirmOrder()" style="flex-grow: 1;">✅ 確認訂單</button>
            </div>
        </form>

        <div id="shareSection">
            <h2>🎉 訂單成立！</h2>
            <p>請將以下資訊傳送給店家確認 (LINE ID: **@198usxgc**)。</p>
            
            <div id="orderPreview"></div>

            <p style="color: var(--danger); font-weight: bold;">⚠️ 請務必將訂單資訊傳送給店家才算完成預訂！</p>

            <div class="share-actions">
                <button class="btn-success" onclick="shareToLine()">📱 傳送至 LINE</button>
                <button class="btn-brand" onclick="copyOrder()">📋 複製訂單內容</button>
                <button type="button" onclick="backToMenu()">🔙 返回選單</button>
            </div>
        </div>

    </div>

    <script>
        // =========================================================
        //                 全域變數與資料 (請自行調整)
        // =========================================================
        let currentOrderId = '';
        let totalResult = {
            total: 0,
            items: [],
            customer: {} // 用於儲存客戶資訊
        };
        
        // 菜單資料結構
        const menuData = [
            {
                category: '熱銷推薦',
                items: [
                    { id: 'duck', name: '九珍薑母鴨 (半隻)', price: 600, limit: 10 },
                    { id: 'soup', name: '濃郁湯頭包', price: 100, limit: 10 },
                ]
            },
            {
                category: '加點單品',
                items: [
                    { id: 'meat', name: '鴨肉丸', price: 50, limit: 20 },
                    { id: 'veggie', name: '高麗菜', price: 40, limit: 20 },
                ]
            }
        ];

        // =========================================================
        //                        核心功能
        // =========================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            renderMenu();
            validateForm();
            initDateTime();
            updateOrderData(); 
            // 監聽表單的即時變更
            document.addEventListener('change', updateConfirmButton);
            document.addEventListener('input', updateConfirmButton);
        });
        
        /**
         * 渲染菜單到頁面上
         */
        function renderMenu() {
            const menuContainer = document.getElementById('menu');
            let html = '';
            
            menuData.forEach(category => {
                html += `<h3>${category.category}</h3>`;
                category.items.forEach(item => {
                    html += `
                        <div class="menu-item">
                            <div>
                                <input type="checkbox" id="${item.id}" value="${item.id}" 
                                       onchange="handleQtyChange('${item.id}', this.checked ? 1 : 0)">
                                <label for="${item.id}">
                                    ${item.name} <span style="color: var(--muted)">(NT$${item.price})</span>
                                </label>
                            </div>
                            <div class="qty-control disabled" data-qty-id="${item.id}">
                                <button type="button" id="minus-${item.id}" disabled 
                                        onclick="updateQty('${item.id}', -1)">-</button>
                                <input type="number" id="qty-${item.id}" value="0" min="0" max="${item.limit}" 
                                       readonly data-price="${item.price}" data-name="${item.name}"
                                       onchange="handleQtyChange('${item.id}', this.value)">
                                <button type="button" id="plus-${item.id}" disabled 
                                        onclick="updateQty('${item.id}', 1)">+</button>
                            </div>
                        </div>
                    `;
                });
            });
            
            menuContainer.innerHTML = html;
        }
        
        /**
         * 處理勾選框和手動輸入數量的變更
         */
        function handleQtyChange(id, value) {
            const checkbox = document.getElementById(id);
            const qtyInput = document.getElementById(`qty-${id}`);
            const qtyContainer = document.querySelector(`[data-qty-id="${id}"]`);
            const minusBtn = document.getElementById(`minus-${id}`);
            const plusBtn = document.getElementById(`plus-${id}`);
            let qty = parseInt(value, 10);
            
            if (qty < 0 || isNaN(qty)) {
                qty = 0;
            } else if (qty > parseInt(qtyInput.max)) {
                qty = parseInt(qtyInput.max);
            }

            qtyInput.value = qty;

            if (qty > 0) {
                checkbox.checked = true;
                qtyContainer.classList.remove('disabled');
                qtyInput.readOnly = false;
                minusBtn.disabled = (qty <= 1);
                plusBtn.disabled = (qty >= parseInt(qtyInput.max));
            } else {
                checkbox.checked = false;
                qtyContainer.classList.add('disabled');
                qtyInput.readOnly = true;
                minusBtn.disabled = true;
                plusBtn.disabled = true;
            }

            updateOrderData();
        }

        /**
         * 處理加/減按鈕
         */
        function updateQty(id, delta) {
            const qtyInput = document.getElementById(`qty-${id}`);
            let currentQty = parseInt(qtyInput.value, 10);
            handleQtyChange(id, currentQty + delta);
        }

        /**
         * 更新訂單總覽區塊
         */
        function updateOrderData() {
            totalResult.items = [];
            let totalQty = 0;
            let totalAmount = 0;
            
            menuData.forEach(category => {
                category.items.forEach(item => {
                    const qtyInput = document.getElementById(`qty-${item.id}`);
                    const qty = parseInt(qtyInput.value, 10);
                    
                    if (qty > 0) {
                        const subtotal = item.price * qty;
                        totalAmount += subtotal;
                        totalQty += qty;
                        totalResult.items.push({
                            id: item.id,
                            name: item.name,
                            price: item.price,
                            qty: qty,
                            subtotal: subtotal 
                        });
                    }
                });
            });
            
            // 這裡可以加入折扣邏輯，例如滿千折百
            if (totalAmount >= 1000) {
                 // 假設滿千折 100
                 totalResult.total = totalAmount - 100;
            } else {
                 totalResult.total = totalAmount;
            }
            
            // 更新 UI
            document.getElementById('totalItemsQty').textContent = totalQty;
            document.getElementById('totalAmount').textContent = `NT$${totalResult.total.toLocaleString()}`;
        }
        
        /**
         * 檢查取餐資訊是否填寫完整並更新確認按鈕狀態
         */
        function updateConfirmButton() {
            const form = document.getElementById('orderForm');
            const confirmBtn = document.getElementById('confirmOrder');
            
            const isFormValid = form.checkValidity();
            const hasItems = totalResult.items.length > 0;
            
            confirmBtn.disabled = !(isFormValid && hasItems);
            
            if (isFormValid && hasItems) {
                confirmBtn.classList.add('btn-brand');
                confirmBtn.classList.remove('btn-muted');
                confirmBtn.textContent = `✅ 確認訂單 (NT$${totalResult.total.toLocaleString()})`;
            } else {
                confirmBtn.classList.add('btn-muted');
                confirmBtn.classList.remove('btn-brand');
                confirmBtn.textContent = '請填寫資訊並選擇品項';
            }
        }

        // =========================================================
        //                     表單驗證 (由使用者提供)
        // =========================================================

        function validateInput(event) {
            const input = event.target;
            // 簡易的必填欄位檢查
            if (input.required && input.value.trim() === '') {
                input.setCustomValidity('此欄位為必填');
            } else if (input.dataset.validateType === 'phone' && input.value && !/^\d{10}$/.test(input.value)) {
                // 簡易手機號碼檢查 (假設為 10 位數字)
                input.setCustomValidity('請輸入有效的手機號碼 (10 位數字)');
            } else {
                input.setCustomValidity(''); // 驗證通過，清除錯誤訊息
            }
            // 強制瀏覽器顯示錯誤訊息
            input.reportValidity();
        }

        function validateForm() {
            const requiredInputs = document.querySelectorAll('#orderForm [required]');
            requiredInputs.forEach(input => {
                input.addEventListener('blur', validateInput);
                input.addEventListener('input', validateInput);
            });
        }

        // =========================================================
        //                   日期時間 (由使用者提供)
        // =========================================================

        function initDateTime() {
            const pickupDate = document.getElementById('pickupDate');
            const pickupTime = document.getElementById('pickupTime');
            
            // 處理日期：鎖定星期一
            const today = new Date();
            let initialDate = new Date(today);
            
            // 確保初始日期不是星期一 (1代表星期一)
            while (initialDate.getDay() === 1) {
                initialDate.setDate(initialDate.getDate() + 1);
            }
            
            const initialDateISO = initialDate.toISOString().split('T')[0];
            pickupDate.value = initialDateISO;
            pickupDate.min = initialDateISO; // 確保不能選過去的日期和今天的公休日

            // 監聽日期變更
            pickupDate.addEventListener('input', function() {
                const selectedDate = new Date(this.value + 'T00:00:00'); // 避免時區問題
                // 檢查是否為星期一
                if (selectedDate.getDay() === 1) {
                    alert('不好意思，我們市場公休，每週一不營業，請選擇其他日期！');
                    
                    // 自動跳到隔天 (星期二)
                    const nextDay = new Date(selectedDate);
                    nextDay.setDate(selectedDate.getDate() + 1);
                    this.value = nextDay.toISOString().split('T')[0];
                }
            });

            // 處理時間：設定為24小時制，預設為最早的 11:00
            pickupTime.value = '11:00';
            
            // 監聽時間變更 (此處由 input 改為 change，確保在選擇完畢後檢查)
            pickupTime.addEventListener('change', function() {
                const time = this.value;
                if (time < '11:00' || time > '19:00') {
                    alert('取餐時間請選擇 11:00-19:00 之間');
                    this.value = '11:00';
                }
            });
        }

        // =========================================================
        //                  訂單操作 (由使用者提供)
        // =========================================================

        function clearOrder() {
            if (confirm('確定要清除目前選單嗎？')) {
                menuData.forEach(category => {
                    category.items.forEach(item => {
                        const checkbox = document.getElementById(item.id);
                        const qtyInput = document.getElementById(`qty-${item.id}`);
                        const qtyContainer = document.querySelector(`[data-qty-id="${item.id}"]`);
                        const minusBtn = document.getElementById(`minus-${item.id}`);
                        const plusBtn = document.getElementById(`plus-${item.id}`);
                        
                        if (checkbox) checkbox.checked = false;
                        if (qtyInput) qtyInput.value = '0';
                        if (qtyContainer) qtyContainer.classList.add('disabled');
                        if (minusBtn) minusBtn.disabled = true;
                        if (plusBtn) plusBtn.disabled = true;
                        if (qtyInput) qtyInput.readOnly = true;
                    });
                });
                // 清空取餐資訊
                document.getElementById('orderForm').reset(); 
                initDateTime(); // 重新設定日期時間
                updateOrderData();
                hideShareSection();
                alert('選單已清除！');
            }
        }
        
        // =========================================================
        //                  API 連線函式 (修正版)
        // =========================================================
        
        /**
         * 嘗試將訂單資料同時發送到本地列印伺服器和遠端 Google Sheets API
         * @param {object} orderData - 完整的訂單資料
         * @returns {object} { printSuccess, remoteSuccess }
         */
        async function sendOrderData(orderData) {
            // 本地列印伺服器的 URL (請確認您的列印服務是否運行在 http://localhost:3000)
            const localServerUrl = 'http://localhost:3000/print-order'; 
            // Google Sheets Apps Script 的 URL (已使用您提供的網址)
            const remoteApiUrl = 'https://script.google.com/macros/s/AKfycbwwC6HFuGUo_U_VxRfGgBX1zQbmXAkZUOTe7zul1VQVInZ2ry5-vKM8L4toVdu74F0eaQ/exec'; 

            let printSuccess = false;
            let remoteSuccess = false;

            // 1. 嘗試發送給本地列印伺服器 (POS機)，設定 5 秒超時
            try {
                const printResponse = await fetch(localServerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData),
                    signal: AbortSignal.timeout(5000) 
                });
                if (printResponse.ok) {
                    console.log("✅ 訂單已成功發送至本地列印伺服器。");
                    printSuccess = true;
                } else {
                    console.error(`🚨 本地列印伺服器回應錯誤: ${printResponse.statusText}`);
                }
            } catch (error) {
                console.error("🚨 無法連線至本地列印伺服器 (可能是服務未啟動):", error);
            }
            
            // 2. 嘗試發送給遠端 API (Google Sheets)
            try {
                const remoteResponse = await fetch(remoteApiUrl, { 
                    method: 'POST',
                    mode: 'no-cors', // Google Apps Script 必須使用 no-cors 模式
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                // no-cors 模式無法檢查 response.ok，這裡假設只要沒有拋出錯誤即為成功發出請求
                console.log("✅ 訂單已成功發送至遠端 API (Google Sheets)。");
                remoteSuccess = true;
            } catch (error) {
                console.error("🚨 無法連線至遠端 API:", error);
            }

            return { printSuccess, remoteSuccess };
        }
        
        // =========================================================
        //                確認訂單 (整合修正版)
        // =========================================================
        
        async function confirmOrder() {
            const form = document.getElementById('orderForm');
            
            // 【修正】確保執行表單和品項檢查
            if (!form.checkValidity()) {
                alert('請填寫完整的取餐資訊！');
                form.reportValidity();
                return;
            }
            if (totalResult.items.length === 0) {
                alert('請至少選擇一個品項！');
                return;
            }

            // 禁用按鈕，防止重複點擊
            const confirmBtn = document.getElementById('confirmOrder');
            confirmBtn.disabled = true; 
            confirmBtn.textContent = '處理中... 請稍候';
            
            // 1. 整理訂單資料 (生成 ID、整理顧客資訊)
            const timestamp = new Date().getTime();
            currentOrderId = `JD${timestamp.toString().slice(-6)}`;

            const orderData = {
                orderId: currentOrderId,
                orderTime: new Date().toISOString(),
                items: totalResult.items.map(item => ({ 
                    ...item,
                    subtotal: item.price * item.qty
                })),
                total: totalResult.total,
                customer: {
                    name: document.getElementById('customerName').value,
                    phone: document.getElementById('customerPhone').value,
                    pickupDate: document.getElementById('pickupDate').value,
                    pickupTime: document.getElementById('pickupTime').value,
                    note: document.getElementById('orderNote').value || '無備註'
                }
            };
            
            // 2. 顯示訂單預覽 (將客戶資訊和 ID 注入到 totalResult 供 showOrderPreview 使用)
            totalResult.orderId = currentOrderId; 
            totalResult.customer = orderData.customer; 
            showOrderPreview(); 

            // 3. 發送資料 (包含本地列印和遠端 API)
            const result = await sendOrderData(orderData);

            // 4. 根據結果處理 UI
            if (result.printSuccess || result.remoteSuccess) {
                // 只要任一連線成功，即視為成功下單
                showShareSection(); 
                
                // 滾動到分享區
                document.getElementById('shareSection').scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            } else {
                // 兩個都失敗，彈出錯誤訊息
                alert('訂單處理失敗！無法連線至本地列印伺服器或遠端API，請檢查服務是否運行。');
            }

            // 重新啟用按鈕
            confirmBtn.disabled = false;
            confirmBtn.textContent = '✅ 確認訂單';
            updateConfirmButton(); // 更新按鈕顯示的總金額
        }

        // =========================================================
        //                     分享與預覽 (由使用者提供)
        // =========================================================

        function showOrderPreview() {
            const now = new Date();
            const orderTime = now.toLocaleString('zh-TW', {
                timeZone: 'Asia/Taipei',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const pickupDate = document.getElementById('pickupDate').value;
            const pickupTime = document.getElementById('pickupTime').value;
            const orderNote = document.getElementById('orderNote').value || '無備註';
            const pickupDateTime = `${pickupDate.replace(/-/g, '/')} ${pickupTime}`;

            let itemsText = totalResult.items.map(item =>
                `• ${item.name} × ${item.qty} → NT$${(item.price * item.qty).toLocaleString()}`
            ).join('\n');
            
            // 如果有折扣，將其加入明細中
            const totalBeforeDiscount = totalResult.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const totalDiscount = totalBeforeDiscount - totalResult.total;
            if (totalDiscount > 0) {
                itemsText += `\n\n優惠折扣：-NT$${totalDiscount.toLocaleString()}`;
            }

            const previewText = `🔔 薑薑鴨肉小館 新訂單 #${currentOrderId}
═══════════════════════
訂單時間：${orderTime}

📋 訂單明細：
${itemsText}

💰 總金額：NT$${totalResult.total.toLocaleString()}

👤 取餐資訊：
姓名：${customerName}
電話：${customerPhone}
取餐時間：${pickupDateTime}
備註：${orderNote}

📍 店家：薑薑 鴨肉小館
請於取餐時間前到店領取，謝謝惠顧！`;

            document.getElementById('orderPreview').textContent = previewText;
        }

        function showShareSection() {
            document.getElementById('orderForm').style.display = 'none'; // 隱藏表單
            document.getElementById('shareSection').style.display = 'block';
        }

        function hideShareSection() {
            document.getElementById('orderForm').style.display = 'block'; // 顯示表單
            document.getElementById('shareSection').style.display = 'none';
        }

        function shareToLine() {
            const orderPreview = document.getElementById('orderPreview').textContent;
            const encodedText = encodeURIComponent(orderPreview);
            const lineUrl = `https://line.me/R/msg/text/?${encodedText}`;
            window.open(lineUrl, '_blank');
            alert('訂單已開啟 LINE，請選擇傳送給店家 (@198usxgc) 或其他聯絡人！');
        }

        async function copyOrder() {
            const orderPreview = document.getElementById('orderPreview').textContent;
            try {
                await navigator.clipboard.writeText(orderPreview);
                alert('訂單內容已複製到剪貼簿！請貼到 LINE 或其他通訊軟體傳送給店家。');
            } catch (err) {
                // 舊版或不支援 navigator.clipboard 的備用方案
                const textArea = document.createElement('textarea');
                textArea.value = orderPreview;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('訂單內容已複製到剪貼簿！請貼到 LINE 或其他通訊軟體傳送給店家。');
            }
        }

        function backToMenu() {
            hideShareSection();
            // 重置訂單狀態，讓用戶可以修改或下新單 (可選)
            // clearOrder(); 
        }

    </script>
</body>
</html>
