<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è–‘è–‘ é´¨è‚‰å°é¤¨ - ç·šä¸Šé»é¤</title>
    <style>
        /* ç‚ºäº†ç°¡æ½”ï¼Œé€™è£¡åªåŒ…å«åŸºç¤æ¨£å¼ï¼Œæ‚¨å¯ä»¥æ›¿æ›ç‚ºæ‚¨åŸæœ¬çš„ CSS */
        :root {
            --brand: #b22222;
            --muted: #666;
            --card-bg: #fff7f7;
            --success: #28a745;
            --danger: #dc3545;
            --gap: 12px;
            --border-radius: 8px;
        }

        * { box-sizing: border-box; }
        body {
            font-family: "Noto Sans TC", Arial, sans-serif;
            margin: 0;
            background: #fafafa;
            color: #222;
            padding: 15px;
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        h2 { border-bottom: 2px solid var(--brand); padding-bottom: 8px; margin-top: 20px; }
        
        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .qty-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .qty-control.disabled button,
        .qty-control.disabled input {
            opacity: 0.5;
            pointer-events: none;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group label { display: block; margin-top: 10px; font-weight: bold; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-brand { background: var(--brand); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        /* è¨‚å–®ç¸½è¦½ */
        #orderResult {
            margin-top: 20px;
            padding: 15px;
            background: var(--card-bg);
            border: 1px solid var(--brand);
            border-radius: var(--border-radius);
        }
        
        #shareSection {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f0f8ff;
            border: 2px solid #007bff;
            border-radius: var(--border-radius);
            text-align: center;
        }

        #orderPreview {
            white-space: pre-wrap;
            text-align: left;
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            background: white;
            font-family: monospace;
        }

        .share-actions button { margin: 5px; }

    </style>
</head>
<body>
    <div class="container">
        <h1>è–‘è–‘ é´¨è‚‰å°é¤¨ ç·šä¸Šé»é¤</h1>

        <h2>ğŸ›’ é¸æ“‡å“é …</h2>
        <div id="menu">
            </div>

        <div id="orderResult">
            <h3>ğŸ’° è¨‚å–®ç¸½è¨ˆ</h3>
            <p>å·²é¸å“é …æ•¸ï¼š<span id="totalItemsQty">0</span> ä»½</p>
            <p>ç¸½é‡‘é¡ï¼š<span id="totalAmount">NT$0</span></p>
        </div>
        
        <h2>ğŸ“ å–é¤è³‡è¨Š</h2>
        <form id="orderForm" novalidate>
            <div class="form-group">
                <label for="customerName">å§“å *</label>
                <input type="text" id="customerName" name="customerName" required placeholder="è«‹è¼¸å…¥å§“å" data-validate-type="text">
            </div>
            <div class="form-group">
                <label for="customerPhone">é›»è©± *</label>
                <input type="tel" id="customerPhone" name="customerPhone" required placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼" data-validate-type="phone">
            </div>
            <div class="form-group">
                <label for="pickupDate">å–é¤æ—¥æœŸ *</label>
                <input type="date" id="pickupDate" name="pickupDate" required>
            </div>
            <div class="form-group">
                <label for="pickupTime">å–é¤æ™‚é–“ * (11:00-19:00)</label>
                <input type="time" id="pickupTime" name="pickupTime" required min="11:00" max="19:00" step="300">
            </div>
            <div class="form-group">
                <label for="orderNote">è¨‚å–®å‚™è¨»</label>
                <textarea id="orderNote" name="orderNote" rows="3" placeholder="ç‰¹æ®Šéœ€æ±‚æˆ–å‚™è¨»"></textarea>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button type="button" id="clearOrderBtn" class="btn-danger" onclick="clearOrder()">ğŸ—‘ï¸ æ¸…é™¤é¸å–®</button>
                <button type="button" id="confirmOrder" class="btn-brand" onclick="confirmOrder()" style="flex-grow: 1;">âœ… ç¢ºèªè¨‚å–®</button>
            </div>
        </form>

        <div id="shareSection">
            <h2>ğŸ‰ è¨‚å–®æˆç«‹ï¼</h2>
            <p>è«‹å°‡ä»¥ä¸‹è³‡è¨Šå‚³é€çµ¦åº—å®¶ç¢ºèª (LINE ID: **@198usxgc**)ã€‚</p>
            
            <div id="orderPreview"></div>

            <p style="color: var(--danger); font-weight: bold;">âš ï¸ è«‹å‹™å¿…å°‡è¨‚å–®è³‡è¨Šå‚³é€çµ¦åº—å®¶æ‰ç®—å®Œæˆé è¨‚ï¼</p>

            <div class="share-actions">
                <button class="btn-success" onclick="shareToLine()">ğŸ“± å‚³é€è‡³ LINE</button>
                <button class="btn-brand" onclick="copyOrder()">ğŸ“‹ è¤‡è£½è¨‚å–®å…§å®¹</button>
                <button type="button" onclick="backToMenu()">ğŸ”™ è¿”å›é¸å–®</button>
            </div>
        </div>

    </div>

    <script>
        // =========================================================
        //                 å…¨åŸŸè®Šæ•¸èˆ‡è³‡æ–™ (è«‹è‡ªè¡Œèª¿æ•´)
        // =========================================================
        let currentOrderId = '';
        let totalResult = {
            total: 0,
            items: [],
            customer: {} // ç”¨æ–¼å„²å­˜å®¢æˆ¶è³‡è¨Š
        };
        
        // èœå–®è³‡æ–™çµæ§‹
        const menuData = [
            {
                category: 'ç†±éŠ·æ¨è–¦',
                items: [
                    { id: 'duck', name: 'ä¹çè–‘æ¯é´¨ (åŠéš»)', price: 600, limit: 10 },
                    { id: 'soup', name: 'æ¿ƒéƒæ¹¯é ­åŒ…', price: 100, limit: 10 },
                ]
            },
            {
                category: 'åŠ é»å–®å“',
                items: [
                    { id: 'meat', name: 'é´¨è‚‰ä¸¸', price: 50, limit: 20 },
                    { id: 'veggie', name: 'é«˜éº—èœ', price: 40, limit: 20 },
                ]
            }
        ];

        // =========================================================
        //                        æ ¸å¿ƒåŠŸèƒ½
        // =========================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            renderMenu();
            validateForm();
            initDateTime();
            updateOrderData(); 
            // ç›£è½è¡¨å–®çš„å³æ™‚è®Šæ›´
            document.addEventListener('change', updateConfirmButton);
            document.addEventListener('input', updateConfirmButton);
        });
        
        /**
         * æ¸²æŸ“èœå–®åˆ°é é¢ä¸Š
         */
        function renderMenu() {
            const menuContainer = document.getElementById('menu');
            let html = '';
            
            menuData.forEach(category => {
                html += `<h3>${category.category}</h3>`;
                category.items.forEach(item => {
                    html += `
                        <div class="menu-item">
                            <div>
                                <input type="checkbox" id="${item.id}" value="${item.id}" 
                                       onchange="handleQtyChange('${item.id}', this.checked ? 1 : 0)">
                                <label for="${item.id}">
                                    ${item.name} <span style="color: var(--muted)">(NT$${item.price})</span>
                                </label>
                            </div>
                            <div class="qty-control disabled" data-qty-id="${item.id}">
                                <button type="button" id="minus-${item.id}" disabled 
                                        onclick="updateQty('${item.id}', -1)">-</button>
                                <input type="number" id="qty-${item.id}" value="0" min="0" max="${item.limit}" 
                                       readonly data-price="${item.price}" data-name="${item.name}"
                                       onchange="handleQtyChange('${item.id}', this.value)">
                                <button type="button" id="plus-${item.id}" disabled 
                                        onclick="updateQty('${item.id}', 1)">+</button>
                            </div>
                        </div>
                    `;
                });
            });
            
            menuContainer.innerHTML = html;
        }
        
        /**
         * è™•ç†å‹¾é¸æ¡†å’Œæ‰‹å‹•è¼¸å…¥æ•¸é‡çš„è®Šæ›´
         */
        function handleQtyChange(id, value) {
            const checkbox = document.getElementById(id);
            const qtyInput = document.getElementById(`qty-${id}`);
            const qtyContainer = document.querySelector(`[data-qty-id="${id}"]`);
            const minusBtn = document.getElementById(`minus-${id}`);
            const plusBtn = document.getElementById(`plus-${id}`);
            let qty = parseInt(value, 10);
            
            if (qty < 0 || isNaN(qty)) {
                qty = 0;
            } else if (qty > parseInt(qtyInput.max)) {
                qty = parseInt(qtyInput.max);
            }

            qtyInput.value = qty;

            if (qty > 0) {
                checkbox.checked = true;
                qtyContainer.classList.remove('disabled');
                qtyInput.readOnly = false;
                minusBtn.disabled = (qty <= 1);
                plusBtn.disabled = (qty >= parseInt(qtyInput.max));
            } else {
                checkbox.checked = false;
                qtyContainer.classList.add('disabled');
                qtyInput.readOnly = true;
                minusBtn.disabled = true;
                plusBtn.disabled = true;
            }

            updateOrderData();
        }

        /**
         * è™•ç†åŠ /æ¸›æŒ‰éˆ•
         */
        function updateQty(id, delta) {
            const qtyInput = document.getElementById(`qty-${id}`);
            let currentQty = parseInt(qtyInput.value, 10);
            handleQtyChange(id, currentQty + delta);
        }

        /**
         * æ›´æ–°è¨‚å–®ç¸½è¦½å€å¡Š
         */
        function updateOrderData() {
            totalResult.items = [];
            let totalQty = 0;
            let totalAmount = 0;
            
            menuData.forEach(category => {
                category.items.forEach(item => {
                    const qtyInput = document.getElementById(`qty-${item.id}`);
                    const qty = parseInt(qtyInput.value, 10);
                    
                    if (qty > 0) {
                        const subtotal = item.price * qty;
                        totalAmount += subtotal;
                        totalQty += qty;
                        totalResult.items.push({
                            id: item.id,
                            name: item.name,
                            price: item.price,
                            qty: qty,
                            subtotal: subtotal 
                        });
                    }
                });
            });
            
            // é€™è£¡å¯ä»¥åŠ å…¥æŠ˜æ‰£é‚è¼¯ï¼Œä¾‹å¦‚æ»¿åƒæŠ˜ç™¾
            if (totalAmount >= 1000) {
                 // å‡è¨­æ»¿åƒæŠ˜ 100
                 totalResult.total = totalAmount - 100;
            } else {
                 totalResult.total = totalAmount;
            }
            
            // æ›´æ–° UI
            document.getElementById('totalItemsQty').textContent = totalQty;
            document.getElementById('totalAmount').textContent = `NT$${totalResult.total.toLocaleString()}`;
        }
        
        /**
         * æª¢æŸ¥å–é¤è³‡è¨Šæ˜¯å¦å¡«å¯«å®Œæ•´ä¸¦æ›´æ–°ç¢ºèªæŒ‰éˆ•ç‹€æ…‹
         */
        function updateConfirmButton() {
            const form = document.getElementById('orderForm');
            const confirmBtn = document.getElementById('confirmOrder');
            
            const isFormValid = form.checkValidity();
            const hasItems = totalResult.items.length > 0;
            
            confirmBtn.disabled = !(isFormValid && hasItems);
            
            if (isFormValid && hasItems) {
                confirmBtn.classList.add('btn-brand');
                confirmBtn.classList.remove('btn-muted');
                confirmBtn.textContent = `âœ… ç¢ºèªè¨‚å–® (NT$${totalResult.total.toLocaleString()})`;
            } else {
                confirmBtn.classList.add('btn-muted');
                confirmBtn.classList.remove('btn-brand');
                confirmBtn.textContent = 'è«‹å¡«å¯«è³‡è¨Šä¸¦é¸æ“‡å“é …';
            }
        }

        // =========================================================
        //                     è¡¨å–®é©—è­‰ (ç”±ä½¿ç”¨è€…æä¾›)
        // =========================================================

        function validateInput(event) {
            const input = event.target;
            // ç°¡æ˜“çš„å¿…å¡«æ¬„ä½æª¢æŸ¥
            if (input.required && input.value.trim() === '') {
                input.setCustomValidity('æ­¤æ¬„ä½ç‚ºå¿…å¡«');
            } else if (input.dataset.validateType === 'phone' && input.value && !/^\d{10}$/.test(input.value)) {
                // ç°¡æ˜“æ‰‹æ©Ÿè™Ÿç¢¼æª¢æŸ¥ (å‡è¨­ç‚º 10 ä½æ•¸å­—)
                input.setCustomValidity('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ‰‹æ©Ÿè™Ÿç¢¼ (10 ä½æ•¸å­—)');
            } else {
                input.setCustomValidity(''); // é©—è­‰é€šéï¼Œæ¸…é™¤éŒ¯èª¤è¨Šæ¯
            }
            // å¼·åˆ¶ç€è¦½å™¨é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            input.reportValidity();
        }

        function validateForm() {
            const requiredInputs = document.querySelectorAll('#orderForm [required]');
            requiredInputs.forEach(input => {
                input.addEventListener('blur', validateInput);
                input.addEventListener('input', validateInput);
            });
        }

        // =========================================================
        //                   æ—¥æœŸæ™‚é–“ (ç”±ä½¿ç”¨è€…æä¾›)
        // =========================================================

        function initDateTime() {
            const pickupDate = document.getElementById('pickupDate');
            const pickupTime = document.getElementById('pickupTime');
            
            // è™•ç†æ—¥æœŸï¼šé–å®šæ˜ŸæœŸä¸€
            const today = new Date();
            let initialDate = new Date(today);
            
            // ç¢ºä¿åˆå§‹æ—¥æœŸä¸æ˜¯æ˜ŸæœŸä¸€ (1ä»£è¡¨æ˜ŸæœŸä¸€)
            while (initialDate.getDay() === 1) {
                initialDate.setDate(initialDate.getDate() + 1);
            }
            
            const initialDateISO = initialDate.toISOString().split('T')[0];
            pickupDate.value = initialDateISO;
            pickupDate.min = initialDateISO; // ç¢ºä¿ä¸èƒ½é¸éå»çš„æ—¥æœŸå’Œä»Šå¤©çš„å…¬ä¼‘æ—¥

            // ç›£è½æ—¥æœŸè®Šæ›´
            pickupDate.addEventListener('input', function() {
                const selectedDate = new Date(this.value + 'T00:00:00'); // é¿å…æ™‚å€å•é¡Œ
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ˜ŸæœŸä¸€
                if (selectedDate.getDay() === 1) {
                    alert('ä¸å¥½æ„æ€ï¼Œæˆ‘å€‘å¸‚å ´å…¬ä¼‘ï¼Œæ¯é€±ä¸€ä¸ç‡Ÿæ¥­ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸï¼');
                    
                    // è‡ªå‹•è·³åˆ°éš”å¤© (æ˜ŸæœŸäºŒ)
                    const nextDay = new Date(selectedDate);
                    nextDay.setDate(selectedDate.getDate() + 1);
                    this.value = nextDay.toISOString().split('T')[0];
                }
            });

            // è™•ç†æ™‚é–“ï¼šè¨­å®šç‚º24å°æ™‚åˆ¶ï¼Œé è¨­ç‚ºæœ€æ—©çš„ 11:00
            pickupTime.value = '11:00';
            
            // ç›£è½æ™‚é–“è®Šæ›´ (æ­¤è™•ç”± input æ”¹ç‚º changeï¼Œç¢ºä¿åœ¨é¸æ“‡å®Œç•¢å¾Œæª¢æŸ¥)
            pickupTime.addEventListener('change', function() {
                const time = this.value;
                if (time < '11:00' || time > '19:00') {
                    alert('å–é¤æ™‚é–“è«‹é¸æ“‡ 11:00-19:00 ä¹‹é–“');
                    this.value = '11:00';
                }
            });
        }

        // =========================================================
        //                  è¨‚å–®æ“ä½œ (ç”±ä½¿ç”¨è€…æä¾›)
        // =========================================================

        function clearOrder() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤ç›®å‰é¸å–®å—ï¼Ÿ')) {
                menuData.forEach(category => {
                    category.items.forEach(item => {
                        const checkbox = document.getElementById(item.id);
                        const qtyInput = document.getElementById(`qty-${item.id}`);
                        const qtyContainer = document.querySelector(`[data-qty-id="${item.id}"]`);
                        const minusBtn = document.getElementById(`minus-${item.id}`);
                        const plusBtn = document.getElementById(`plus-${item.id}`);
                        
                        if (checkbox) checkbox.checked = false;
                        if (qtyInput) qtyInput.value = '0';
                        if (qtyContainer) qtyContainer.classList.add('disabled');
                        if (minusBtn) minusBtn.disabled = true;
                        if (plusBtn) plusBtn.disabled = true;
                        if (qtyInput) qtyInput.readOnly = true;
                    });
                });
                // æ¸…ç©ºå–é¤è³‡è¨Š
                document.getElementById('orderForm').reset(); 
                initDateTime(); // é‡æ–°è¨­å®šæ—¥æœŸæ™‚é–“
                updateOrderData();
                hideShareSection();
                alert('é¸å–®å·²æ¸…é™¤ï¼');
            }
        }
        
        // =========================================================
        //                  API é€£ç·šå‡½å¼ (ä¿®æ­£ç‰ˆ)
        // =========================================================
        
        /**
         * å˜—è©¦å°‡è¨‚å–®è³‡æ–™åŒæ™‚ç™¼é€åˆ°æœ¬åœ°åˆ—å°ä¼ºæœå™¨å’Œé ç«¯ Google Sheets API
         * @param {object} orderData - å®Œæ•´çš„è¨‚å–®è³‡æ–™
         * @returns {object} { printSuccess, remoteSuccess }
         */
        async function sendOrderData(orderData) {
            // æœ¬åœ°åˆ—å°ä¼ºæœå™¨çš„ URL (è«‹ç¢ºèªæ‚¨çš„åˆ—å°æœå‹™æ˜¯å¦é‹è¡Œåœ¨ http://localhost:3000)
            const localServerUrl = 'http://localhost:3000/print-order'; 
            // Google Sheets Apps Script çš„ URL (å·²ä½¿ç”¨æ‚¨æä¾›çš„ç¶²å€)
            const remoteApiUrl = 'https://script.google.com/macros/s/AKfycbwwC6HFuGUo_U_VxRfGgBX1zQbmXAkZUOTe7zul1VQVInZ2ry5-vKM8L4toVdu74F0eaQ/exec'; 

            let printSuccess = false;
            let remoteSuccess = false;

            // 1. å˜—è©¦ç™¼é€çµ¦æœ¬åœ°åˆ—å°ä¼ºæœå™¨ (POSæ©Ÿ)ï¼Œè¨­å®š 5 ç§’è¶…æ™‚
            try {
                const printResponse = await fetch(localServerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData),
                    signal: AbortSignal.timeout(5000) 
                });
                if (printResponse.ok) {
                    console.log("âœ… è¨‚å–®å·²æˆåŠŸç™¼é€è‡³æœ¬åœ°åˆ—å°ä¼ºæœå™¨ã€‚");
                    printSuccess = true;
                } else {
                    console.error(`ğŸš¨ æœ¬åœ°åˆ—å°ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ${printResponse.statusText}`);
                }
            } catch (error) {
                console.error("ğŸš¨ ç„¡æ³•é€£ç·šè‡³æœ¬åœ°åˆ—å°ä¼ºæœå™¨ (å¯èƒ½æ˜¯æœå‹™æœªå•Ÿå‹•):", error);
            }
            
            // 2. å˜—è©¦ç™¼é€çµ¦é ç«¯ API (Google Sheets)
            try {
                const remoteResponse = await fetch(remoteApiUrl, { 
                    method: 'POST',
                    mode: 'no-cors', // Google Apps Script å¿…é ˆä½¿ç”¨ no-cors æ¨¡å¼
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                // no-cors æ¨¡å¼ç„¡æ³•æª¢æŸ¥ response.okï¼Œé€™è£¡å‡è¨­åªè¦æ²’æœ‰æ‹‹å‡ºéŒ¯èª¤å³ç‚ºæˆåŠŸç™¼å‡ºè«‹æ±‚
                console.log("âœ… è¨‚å–®å·²æˆåŠŸç™¼é€è‡³é ç«¯ API (Google Sheets)ã€‚");
                remoteSuccess = true;
            } catch (error) {
                console.error("ğŸš¨ ç„¡æ³•é€£ç·šè‡³é ç«¯ API:", error);
            }

            return { printSuccess, remoteSuccess };
        }
        
        // =========================================================
        //                ç¢ºèªè¨‚å–® (æ•´åˆä¿®æ­£ç‰ˆ)
        // =========================================================
        
        async function confirmOrder() {
            const form = document.getElementById('orderForm');
            
            // ã€ä¿®æ­£ã€‘ç¢ºä¿åŸ·è¡Œè¡¨å–®å’Œå“é …æª¢æŸ¥
            if (!form.checkValidity()) {
                alert('è«‹å¡«å¯«å®Œæ•´çš„å–é¤è³‡è¨Šï¼');
                form.reportValidity();
                return;
            }
            if (totalResult.items.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å“é …ï¼');
                return;
            }

            // ç¦ç”¨æŒ‰éˆ•ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
            const confirmBtn = document.getElementById('confirmOrder');
            confirmBtn.disabled = true; 
            confirmBtn.textContent = 'è™•ç†ä¸­... è«‹ç¨å€™';
            
            // 1. æ•´ç†è¨‚å–®è³‡æ–™ (ç”Ÿæˆ IDã€æ•´ç†é¡§å®¢è³‡è¨Š)
            const timestamp = new Date().getTime();
            currentOrderId = `JD${timestamp.toString().slice(-6)}`;

            const orderData = {
                orderId: currentOrderId,
                orderTime: new Date().toISOString(),
                items: totalResult.items.map(item => ({ 
                    ...item,
                    subtotal: item.price * item.qty
                })),
                total: totalResult.total,
                customer: {
                    name: document.getElementById('customerName').value,
                    phone: document.getElementById('customerPhone').value,
                    pickupDate: document.getElementById('pickupDate').value,
                    pickupTime: document.getElementById('pickupTime').value,
                    note: document.getElementById('orderNote').value || 'ç„¡å‚™è¨»'
                }
            };
            
            // 2. é¡¯ç¤ºè¨‚å–®é è¦½ (å°‡å®¢æˆ¶è³‡è¨Šå’Œ ID æ³¨å…¥åˆ° totalResult ä¾› showOrderPreview ä½¿ç”¨)
            totalResult.orderId = currentOrderId; 
            totalResult.customer = orderData.customer; 
            showOrderPreview(); 

            // 3. ç™¼é€è³‡æ–™ (åŒ…å«æœ¬åœ°åˆ—å°å’Œé ç«¯ API)
            const result = await sendOrderData(orderData);

            // 4. æ ¹æ“šçµæœè™•ç† UI
            if (result.printSuccess || result.remoteSuccess) {
                // åªè¦ä»»ä¸€é€£ç·šæˆåŠŸï¼Œå³è¦–ç‚ºæˆåŠŸä¸‹å–®
                showShareSection(); 
                
                // æ»¾å‹•åˆ°åˆ†äº«å€
                document.getElementById('shareSection').scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            } else {
                // å…©å€‹éƒ½å¤±æ•—ï¼Œå½ˆå‡ºéŒ¯èª¤è¨Šæ¯
                alert('è¨‚å–®è™•ç†å¤±æ•—ï¼ç„¡æ³•é€£ç·šè‡³æœ¬åœ°åˆ—å°ä¼ºæœå™¨æˆ–é ç«¯APIï¼Œè«‹æª¢æŸ¥æœå‹™æ˜¯å¦é‹è¡Œã€‚');
            }

            // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'âœ… ç¢ºèªè¨‚å–®';
            updateConfirmButton(); // æ›´æ–°æŒ‰éˆ•é¡¯ç¤ºçš„ç¸½é‡‘é¡
        }

        // =========================================================
        //                     åˆ†äº«èˆ‡é è¦½ (ç”±ä½¿ç”¨è€…æä¾›)
        // =========================================================

        function showOrderPreview() {
            const now = new Date();
            const orderTime = now.toLocaleString('zh-TW', {
                timeZone: 'Asia/Taipei',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const pickupDate = document.getElementById('pickupDate').value;
            const pickupTime = document.getElementById('pickupTime').value;
            const orderNote = document.getElementById('orderNote').value || 'ç„¡å‚™è¨»';
            const pickupDateTime = `${pickupDate.replace(/-/g, '/')} ${pickupTime}`;

            let itemsText = totalResult.items.map(item =>
                `â€¢ ${item.name} Ã— ${item.qty} â†’ NT$${(item.price * item.qty).toLocaleString()}`
            ).join('\n');
            
            // å¦‚æœæœ‰æŠ˜æ‰£ï¼Œå°‡å…¶åŠ å…¥æ˜ç´°ä¸­
            const totalBeforeDiscount = totalResult.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const totalDiscount = totalBeforeDiscount - totalResult.total;
            if (totalDiscount > 0) {
                itemsText += `\n\nå„ªæƒ æŠ˜æ‰£ï¼š-NT$${totalDiscount.toLocaleString()}`;
            }

            const previewText = `ğŸ”” è–‘è–‘é´¨è‚‰å°é¤¨ æ–°è¨‚å–® #${currentOrderId}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¨‚å–®æ™‚é–“ï¼š${orderTime}

ğŸ“‹ è¨‚å–®æ˜ç´°ï¼š
${itemsText}

ğŸ’° ç¸½é‡‘é¡ï¼šNT$${totalResult.total.toLocaleString()}

ğŸ‘¤ å–é¤è³‡è¨Šï¼š
å§“åï¼š${customerName}
é›»è©±ï¼š${customerPhone}
å–é¤æ™‚é–“ï¼š${pickupDateTime}
å‚™è¨»ï¼š${orderNote}

ğŸ“ åº—å®¶ï¼šè–‘è–‘ é´¨è‚‰å°é¤¨
è«‹æ–¼å–é¤æ™‚é–“å‰åˆ°åº—é ˜å–ï¼Œè¬è¬æƒ é¡§ï¼`;

            document.getElementById('orderPreview').textContent = previewText;
        }

        function showShareSection() {
            document.getElementById('orderForm').style.display = 'none'; // éš±è—è¡¨å–®
            document.getElementById('shareSection').style.display = 'block';
        }

        function hideShareSection() {
            document.getElementById('orderForm').style.display = 'block'; // é¡¯ç¤ºè¡¨å–®
            document.getElementById('shareSection').style.display = 'none';
        }

        function shareToLine() {
            const orderPreview = document.getElementById('orderPreview').textContent;
            const encodedText = encodeURIComponent(orderPreview);
            const lineUrl = `https://line.me/R/msg/text/?${encodedText}`;
            window.open(lineUrl, '_blank');
            alert('è¨‚å–®å·²é–‹å•Ÿ LINEï¼Œè«‹é¸æ“‡å‚³é€çµ¦åº—å®¶ (@198usxgc) æˆ–å…¶ä»–è¯çµ¡äººï¼');
        }

        async function copyOrder() {
            const orderPreview = document.getElementById('orderPreview').textContent;
            try {
                await navigator.clipboard.writeText(orderPreview);
                alert('è¨‚å–®å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼è«‹è²¼åˆ° LINE æˆ–å…¶ä»–é€šè¨Šè»Ÿé«”å‚³é€çµ¦åº—å®¶ã€‚');
            } catch (err) {
                // èˆŠç‰ˆæˆ–ä¸æ”¯æ´ navigator.clipboard çš„å‚™ç”¨æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = orderPreview;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('è¨‚å–®å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼è«‹è²¼åˆ° LINE æˆ–å…¶ä»–é€šè¨Šè»Ÿé«”å‚³é€çµ¦åº—å®¶ã€‚');
            }
        }

        function backToMenu() {
            hideShareSection();
            // é‡ç½®è¨‚å–®ç‹€æ…‹ï¼Œè®“ç”¨æˆ¶å¯ä»¥ä¿®æ”¹æˆ–ä¸‹æ–°å–® (å¯é¸)
            // clearOrder(); 
        }

    </script>
</body>
</html>
